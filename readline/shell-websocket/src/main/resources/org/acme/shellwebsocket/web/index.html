<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>&#198;sh Readline - WebSocket Shell</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #1e1e1e;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
    }

    .wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
    }

    h1 {
      margin: 0 0 20px 0;
      font-size: 24px;
      color: #f0f0f0;
      text-align: center;
    }

    #terminal-container {
      border: 2px solid #444;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      padding: 10px;
      background: #000;
      /* Fixed size terminal - no auto-fitting */
    }

    .connection-status {
      margin-bottom: 15px;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      display: inline-block;
    }

    .status-connected {
      background: #1a472a;
      color: #4ade80;
    }

    .status-disconnected {
      background: #4a1a1a;
      color: #f87171;
    }

    .status-connecting {
      background: #4a3a1a;
      color: #fbbf24;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>&#198;sh Readline - WebSocket Shell</h1>
    <div id="status" class="connection-status status-connecting">Connecting...</div>
    <div id="terminal-container"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js"></script>
  <script>
    (function() {
      'use strict';

      var statusEl = document.getElementById('status');

      function setStatus(status, message) {
        statusEl.className = 'connection-status status-' + status;
        statusEl.textContent = message;
      }

      function connect() {
        var wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        var wsHost = window.location.host || 'localhost:8080';
        var wsUrl = wsProtocol + '//' + wsHost + '/ws';

        setStatus('connecting', 'Connecting to ' + wsUrl + '...');

        var socket = new WebSocket(wsUrl);

        socket.onopen = function() {
          setStatus('connected', 'Connected');

          // Create terminal with xterm.js (fixed size 120x40)
          var term = new Terminal({
            cols: 120,
            rows: 40,
            cursorBlink: true,
            cursorStyle: 'block',
            fontFamily: '"DejaVu Sans Mono", "Liberation Mono", "Courier New", monospace',
            fontSize: 14,
            theme: {
              background: '#000000',
              foreground: '#f0f0f0',
              cursor: '#f0f0f0',
              cursorAccent: '#000000',
              selectionBackground: 'rgba(255, 255, 255, 0.3)'
            }
          });

          // Open terminal in container
          term.open(document.getElementById('terminal-container'));

          // Handle incoming data from server
          socket.onmessage = function(event) {
            if (event.type === 'message') {
              term.write(event.data);
            }
          };

          // Handle user input
          term.onData(function(data) {
            socket.send(JSON.stringify({action: 'read', data: data}));
          });

          // Handle connection close
          socket.onclose = function(event) {
            setStatus('disconnected', 'Disconnected (code: ' + event.code + ')');
            term.write('\r\n\x1b[31mConnection closed.\x1b[0m\r\n');
            socket.onmessage = null;
            socket.onclose = null;
          };

          // Handle connection error
          socket.onerror = function(error) {
            setStatus('disconnected', 'Connection error');
            console.error('WebSocket error:', error);
          };

          // Focus terminal
          term.focus();
        };

        socket.onerror = function(error) {
          setStatus('disconnected', 'Failed to connect');
          console.error('WebSocket connection error:', error);
        };
      }

      // Connect when page loads
      window.addEventListener('load', connect);
    })();
  </script>
</body>
</html>
